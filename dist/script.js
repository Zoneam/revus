(()=>{"use strict";const{log:e}=console;let t=document.getElementById("imageBlock");const r=async()=>{const e=document.getElementById("summaryBtnContainer");let t=e?document.querySelector(".summaryBtn"):null;t||(t=document.createElement("button"),t.className="summaryBtn",e.appendChild(t));const r=t.cloneNode(!0);t.replaceWith(r),t=r,await o()?(t.innerText="Summarize Reviews",t.disabled=!1,t.addEventListener("click",(async function(){t.innerText="Summarizing......",t.disabled=!0;let e=[];const r=document.getElementById("imageBlock");document.querySelectorAll(".review-text-content > span").forEach(((t,r)=>{const o=t.textContent.trim();e.push(o)}));const{summary:o}=await n({reviews:e});if(console.log(o),r){const e=document.createElement("div");e.setAttribute("id","review"),e.innerHTML+="<h3>Summary</h3>",o.length&&o.split("\n").forEach((t=>{e.innerHTML+=`<li class="list-problem">${t}</li>`})),r.appendChild(e),t.disabled=!1,t.innerText="Summarize Again"}}))):(t.innerText="Please Login to Summarize Reviews",t.disabled=!1,t.addEventListener("click",(function(){chrome.runtime.sendMessage({action:"openPopup"},(function(e){chrome.runtime.lastError?console.error(`Error opening popup: ${chrome.runtime.lastError.message}`):console.log("Popup opened for login.")}))})))},o=()=>new Promise(((e,t)=>{chrome.storage.local.get(["token"],(function(r){chrome.runtime.lastError?t(`Error retrieving token: ${chrome.runtime.lastError.message}`):e(!!r.token)}))}));if(t){const e=document.createElement("div");e.setAttribute("id","summaryBtnContainer"),t.appendChild(e),r(),chrome.storage.onChanged.addListener(((e,t)=>{e.token&&r()}))}else e("No reviews found!");const n=async(e,t=3)=>{const r={"Content-Type":"application/json",Authorization:`Bearer ${await new Promise(((e,t)=>{chrome.storage.local.get(["token"],(function(r){chrome.runtime.lastError?t(`Error retrieving token: ${chrome.runtime.lastError.message}`):e(r.token)}))}))}`};if(0===e.length)return void console.error("No reviews provided");let o;try{o=JSON.stringify(e)}catch(e){return console.error("Failed to stringify reviews",e),{error:!0,message:`Failed to stringify reviews. Error: ${e.message}`}}const n=(e,r)=>{if(console.error(`Attempt ${r} ERROR:`,e.message),r>=t||!e.message.startsWith("Response error")||parseInt(e.message.split(": ")[1])<500)throw e};for(let e=0;e<=t;e++)try{const e=await fetch("https://frmme9pn2h.execute-api.us-east-1.amazonaws.com/stage/revus",{method:"POST",headers:r,body:o});if(!e.ok)throw new Error(`Response error with status code: ${e.status}`);return await e.json()}catch(t){n(t,e+1)}return{error:!0,message:`Failed to summarize reviews after ${t+1} attempts.`}}})();